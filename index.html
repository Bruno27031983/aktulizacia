
<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator</title>
  <!-- Manifest pre PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <!-- Zahrnutie kni≈æn√≠c pre export do PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .autor-info {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 14px;
      font-style: italic;
      color: #666;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .settings > div {
      flex: 1 1 200px;
      margin: 5px;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) {
      width: 25%;
    }
    th:nth-child(1), td:nth-child(1),
    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(8), td:nth-child(8) {
      width: 8.33%;
    }
    input[type="tel"], input[type="number"], input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    /* Tlaƒçidl√° roztiahnut√© na cel√∫ ≈°√≠rku, ka≈æd√Ω na vlastnom riadku */
    .btn-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
      margin-top: 20px;
    }
    .btn {
      width: 100%;
      padding: 15px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      text-align: center;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .restore-btn {
      background-color: #9C27B0;
    }
    .restore-btn:hover {
      background-color: #7B1FA2;
    }
    .backup-btn {
      background-color: #FFA500;
    }
    .backup-btn:hover {
      background-color: #E68900;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    .container.dark-mode {
      background-color: #444;
      color: #f4f4f4;
    }
    table.dark-mode {
      background-color: #555;
      color: #f4f4f4;
    }
    th.dark-mode {
      background-color: #666;
    }
    td.dark-mode {
      background-color: #444;
      color: #f4f4f4;
    }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode {
      background-color: #666;
      color: white;
    }
    .btn.dark-mode {
      color: #333;
    }
    .reset-btn.dark-mode {
      background-color: #d32f2f;
    }
    .export-btn.dark-mode {
      background-color: #388e3c;
    }
    #totalSalary.dark-mode {
      background-color: #2c3e50;
    }
    .current-day.dark-mode {
      background-color: #4a0e8f;
      color: #fff;
    }
    .current-day.dark-mode input {
      background-color: #5c1db3;
      color: #fff;
    }
    body.dark-mode .autor-info {
      color: #aaa;
    }
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                     0 0 20px rgba(255, 255, 255, 0.3),
                     0 0 30px rgba(255, 255, 255, 0.2);
      }
      50% {
        text-shadow: 0 0 20px rgba(255, 255, 255, 1),
                     0 0 30px rgba(255, 255, 255, 0.9),
                     0 0 40px rgba(255, 255, 255, 0.7);
      }
    }
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex: 1 1 auto; margin: 10px 0; }
      table { min-width: 800px; }
      th, td { padding: 6px; font-size: 0.8em; }
      .btn { font-size: 14px; padding: 10px 16px; }
      #totalSalary { font-size: 16px; }
      #dataSizeContainer { font-size: 12px; }
      .table-container { overflow-x: auto; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 8px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"] { font-size: 12px; }
      table { min-width: 800px; }
    }
    #saveNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show {
      display: block;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="autor-info">Vytvoril a financoval Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2></h2>
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovn√≠ka: </label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Da≈àov√© percento (%): </label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Janu√°r</option>
          <option value="1">Febru√°r</option>
          <option value="2">Marec</option>
          <option value="3">Apr√≠l</option>
          <option value="4">M√°j</option>
          <option value="5">J√∫n</option>
          <option value="6">J√∫l</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Okt√≥ber</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()">
          <!-- Dynamicky generovan√© roky -->
        </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky bud√∫ pridan√© cez JavaScript -->
        </tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Veƒækos≈• d√°t: 0 KB / 4096 KB</div>
      <div id="dataSizeBar">
        <div id="dataSizeFill"></div>
      </div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• v≈°etko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈•</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
    </div>
  </div>

  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>

  <script>
    // ==========================================
    // MAXIM√ÅLNA OCHRANA D√ÅT PROTI VYMAZANIU
    // ==========================================

    // 1. Persistence API - Po≈æiada≈• o trval√© √∫lo≈æisko
    if (navigator.storage && navigator.storage.persist) {
      navigator.storage.persist().then(granted => {
        if (granted) {
          console.log('‚úÖ Trval√© √∫lo≈æisko schv√°len√© - d√°ta bud√∫ chr√°nen√©');
        } else {
          console.log('‚ö†Ô∏è Trval√© √∫lo≈æisko neschv√°len√© - d√°ta m√¥≈æu by≈• vymazan√©');
        }
      });
    }

    // 2. IndexedDB - Trvalej≈°ie √∫lo≈æisko ako localStorage
    let db;
    const DB_NAME = 'BrunosCalculatorDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'workData';

    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          console.log('‚úÖ IndexedDB inicializovan√°');
          resolve(db);
        };

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            console.log('‚úÖ IndexedDB object store vytvoren√Ω');
          }
        };
      });
    }

    // Ulo≈æenie do IndexedDB
    function saveToIndexedDB(data) {
      if (!db) return Promise.resolve();

      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put({
          id: 'workDaysData',
          data: data,
          timestamp: new Date().toISOString()
        });

        request.onsuccess = () => {
          console.log('‚úÖ D√°ta ulo≈æen√© do IndexedDB');
          resolve();
        };
        request.onerror = () => reject(request.error);
      });
    }

    // Naƒç√≠tanie z IndexedDB
    function loadFromIndexedDB() {
      if (!db) return Promise.resolve(null);

      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get('workDaysData');

        request.onsuccess = () => {
          if (request.result) {
            console.log('‚úÖ D√°ta naƒç√≠tan√© z IndexedDB');
            resolve(request.result.data);
          } else {
            resolve(null);
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    // 3. Automatick√© z√°lohovanie ka≈æd√Ωch 5 min√∫t
    let autoBackupInterval;
    function startAutoBackup() {
      autoBackupInterval = setInterval(() => {
        const backupData = {
          workDaysData: localStorage.getItem('workDaysData'),
          hourlyWage: localStorage.getItem('hourlyWage'),
          taxRate: localStorage.getItem('taxRate'),
          darkMode: localStorage.getItem('darkMode'),
          decimalPlaces: localStorage.getItem('decimalPlaces'),
          employeeName: localStorage.getItem('employeeName'),
          timestamp: new Date().toISOString()
        };

        // Ulo≈æi≈• do viacer√Ωch √∫lo≈æ√≠sk
        if (backupData.workDaysData) {
          // IndexedDB backup
          saveToIndexedDB(backupData).catch(err => console.error('IndexedDB backup error:', err));

          // SessionStorage backup (pre aktu√°lnu session)
          try {
            sessionStorage.setItem('brunosCalculatorBackup', JSON.stringify(backupData));
            console.log('üîÑ Automatick√° z√°loha vytvoren√°');
          } catch (e) {
            console.error('SessionStorage backup error:', e);
          }
        }
      }, 5 * 60 * 1000); // ka≈æd√Ωch 5 min√∫t
    }

    // 4. Recovery mechanizmus - pokus naƒç√≠ta≈• z viacer√Ωch zdrojov
    async function recoverData() {
      console.log('üîç Hƒæad√°m d√°ta pre obnovenie...');

      // Sk√∫s localStorage
      let data = localStorage.getItem('workDaysData');
      if (data) {
        console.log('‚úÖ D√°ta n√°jden√© v localStorage');
        return JSON.parse(data);
      }

      // Sk√∫s IndexedDB
      try {
        const idbData = await loadFromIndexedDB();
        if (idbData && idbData.workDaysData) {
          console.log('‚úÖ D√°ta obnoven√© z IndexedDB');
          // Obnov sp√§≈• do localStorage
          localStorage.setItem('workDaysData', idbData.workDaysData);
          localStorage.setItem('hourlyWage', idbData.hourlyWage || '10');
          localStorage.setItem('taxRate', idbData.taxRate || '0.02');
          localStorage.setItem('darkMode', idbData.darkMode || 'false');
          localStorage.setItem('decimalPlaces', idbData.decimalPlaces || '1');
          localStorage.setItem('employeeName', idbData.employeeName || '""');
          return JSON.parse(idbData.workDaysData);
        }
      } catch (e) {
        console.error('IndexedDB recovery error:', e);
      }

      // Sk√∫s sessionStorage
      try {
        const sessionData = sessionStorage.getItem('brunosCalculatorBackup');
        if (sessionData) {
          const backup = JSON.parse(sessionData);
          console.log('‚úÖ D√°ta obnoven√© zo sessionStorage');
          // Obnov sp√§≈• do localStorage
          Object.keys(backup).forEach(key => {
            if (key !== 'timestamp' && backup[key]) {
              localStorage.setItem(key, backup[key]);
            }
          });
          return JSON.parse(backup.workDaysData);
        }
      } catch (e) {
        console.error('SessionStorage recovery error:', e);
      }

      console.log('‚ö†Ô∏è ≈Ωiadne d√°ta na obnovenie nen√°jden√©');
      return null;
    }

    // 5. Upozornenie pred zatvoren√≠m str√°nky ak s√∫ neulo≈æen√© zmeny
    let hasUnsavedChanges = false;
    window.addEventListener('beforeunload', (event) => {
      // V≈ædy ulo≈æi≈• pred zatvoren√≠m
      const data = localStorage.getItem('workDaysData');
      if (data) {
        saveToIndexedDB({
          workDaysData: data,
          hourlyWage: localStorage.getItem('hourlyWage'),
          taxRate: localStorage.getItem('taxRate'),
          darkMode: localStorage.getItem('darkMode'),
          decimalPlaces: localStorage.getItem('decimalPlaces'),
          employeeName: localStorage.getItem('employeeName')
        }).catch(err => console.error('Error saving on unload:', err));
      }

      // Ak s√∫ d√°ta, upozorni pou≈æ√≠vateƒæa
      if (data && data !== '{}') {
        event.preventDefault();
        event.returnValue = 'M√°te ulo≈æen√© pracovn√© hodiny. Naozaj chcete od√≠s≈•?';
        return event.returnValue;
      }
    });

    // 6. Detekcia vymazania localStorage a automatick√© obnovenie
    window.addEventListener('storage', async (event) => {
      if (event.key === 'workDaysData' && !event.newValue && event.oldValue) {
        console.log('‚ö†Ô∏è Detekovan√© vymazanie d√°t! Pok√∫≈°am sa obnovi≈•...');
        const recovered = await recoverData();
        if (recovered) {
          alert('‚ö†Ô∏è D√°ta boli vymazan√©, ale √∫spe≈°ne obnoven√© zo z√°lohy!');
          location.reload();
        } else {
          alert('‚ùå D√°ta boli vymazan√© a nepodarilo sa ich obnovi≈•. Pou≈æite funkciu "Obnovi≈• z√°lohu" ak m√°te ulo≈æen√Ω backup s√∫bor.');
        }
      }
    });

    // 7. Pravideln√° kontrola integrity d√°t
    setInterval(() => {
      const data = localStorage.getItem('workDaysData');
      if (data && data !== '{}') {
        // D√°ta existuj√∫, urob tich√∫ z√°lohu
        saveToIndexedDB({
          workDaysData: data,
          hourlyWage: localStorage.getItem('hourlyWage'),
          taxRate: localStorage.getItem('taxRate'),
          darkMode: localStorage.getItem('darkMode'),
          decimalPlaces: localStorage.getItem('decimalPlaces'),
          employeeName: localStorage.getItem('employeeName')
        }).catch(err => console.error('Silent backup error:', err));
      }
    }, 2 * 60 * 1000); // ka≈æd√© 2 min√∫ty

    // Registr√°cia Service Worker pre PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => console.log('Service Worker zaregistrovan√Ω:', registration))
          .catch(error => console.error('Chyba pri registr√°cii Service Worker:', error));
      });
    }

    // Inicializ√°cia IndexedDB a automatick√©ho z√°lohovania
    initIndexedDB().then(() => {
      startAutoBackup();
      console.log('‚úÖ Ochrann√Ω syst√©m d√°t aktivovan√Ω');
    }).catch(err => {
      console.error('Chyba pri inicializ√°cii IndexedDB:', err);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const workDays = document.getElementById('workDays');
      const totalSalaryDiv = document.getElementById('totalSalary');
      const dataSizeText = document.getElementById('dataSizeText');
      const dataSizeFill = document.getElementById('dataSizeFill');
      const mainTitle = document.getElementById('mainTitle');
      const hourlyWageInput = document.getElementById('hourlyWageInput');
      const taxRateInput = document.getElementById('taxRateInput');
      const monthSelect = document.getElementById('monthSelect');
      const yearSelect = document.getElementById('yearSelect');
      const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
      const employeeNameInput = document.getElementById('employeeNameInput');

      const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4 MB
      const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024; // 4096 KB

      const currentDate = new Date();
      let currentMonth = currentDate.getMonth();
      let currentYear = currentDate.getFullYear();

      function populateYearSelect() {
        const startYear = 2020;
        const endYear = 2030;
        for (let year = startYear; year <= endYear; year++) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        }
      }

      populateYearSelect();
      monthSelect.value = currentMonth;
      yearSelect.value = currentYear;

      let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
      decimalPlacesSelect.value = decimalPlaces;

      let employeeName = localStorage.getItem('employeeName') || '';
      employeeNameInput.value = employeeName;

      let hourlyWage = parseFloat(hourlyWageInput.value);
      let taxRate = parseFloat(taxRateInput.value) / 100;
      let monthData = {};

      console.log(`Inicializ√°cia: Mesiac=${currentMonth}, Rok=${currentYear}, Desatinn√© miesta=${decimalPlaces}, Meno=${employeeName}`);

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 300);

      function showSaveNotification() {
        const notification = document.getElementById('saveNotification');
        notification.classList.add('show');
        setTimeout(() => {
          notification.classList.remove('show');
        }, 2000);
      }

      function saveToLocalStorage() {
        try {
          console.log(`Ukladanie d√°t pre Rok=${currentYear}, Mesiac=${currentMonth}`);
          const data = [];
          for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);
            const start = startElement ? startElement.value : '';
            const end = endElement ? endElement.value : '';
            const breakTime = breakElement ? breakElement.value : '';
            const gross = grossElement ? grossElement.value : '0.00';
            const net = netElement ? netElement.value : '0.00';
            data.push({ start, end, breakTime, gross, net });
          }
          if (!monthData[currentYear]) {
            monthData[currentYear] = {};
          }
          monthData[currentYear][currentMonth] = data;
          const serializedData = JSON.stringify(monthData);
          const serializedHourlyWage = JSON.stringify(hourlyWage);
          const serializedTaxRate = JSON.stringify(taxRate);
          const serializedDarkMode = JSON.stringify(document.body.classList.contains('dark-mode'));
          const serializedDecimalPlaces = JSON.stringify(decimalPlaces);
          const serializedEmployeeName = JSON.stringify(employeeName);
          const totalData = serializedData + serializedHourlyWage + serializedTaxRate + serializedDarkMode + serializedDecimalPlaces + serializedEmployeeName;
          const bytes = new Blob([totalData]).size;
          console.log(`Celkov√° veƒækos≈• d√°t: ${bytes} bajtov`);
          if (bytes > MAX_DATA_SIZE) {
            alert(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (${(MAX_DATA_SIZE_KB).toFixed(2)} KB). D√°ta neboli ulo≈æen√©.`);
            return;
          }
          localStorage.setItem('workDaysData', serializedData);
          localStorage.setItem('hourlyWage', serializedHourlyWage);
          localStorage.setItem('taxRate', serializedTaxRate);
          localStorage.setItem('darkMode', serializedDarkMode);
          localStorage.setItem('decimalPlaces', serializedDecimalPlaces);
          localStorage.setItem('employeeName', serializedEmployeeName);
          console.log('D√°ta ulo≈æen√© do localStorage:', monthData);

          // Ulo≈æi≈• aj do IndexedDB pre extra ochranu
          saveToIndexedDB({
            workDaysData: serializedData,
            hourlyWage: serializedHourlyWage,
            taxRate: serializedTaxRate,
            darkMode: serializedDarkMode,
            decimalPlaces: serializedDecimalPlaces,
            employeeName: serializedEmployeeName
          }).catch(err => console.error('Chyba pri ukladan√≠ do IndexedDB:', err));

          updateDataSize();
          showSaveNotification();
        } catch (error) {
          console.error('Chyba pri ukladan√≠ do localStorage:', error);
        }
      }

      async function loadFromLocalStorage() {
        try {
          console.log(`Naƒç√≠tanie d√°t pre Rok=${currentYear}, Mesiac=${currentMonth}`);
          let storedData = JSON.parse(localStorage.getItem('workDaysData'));

          // Ak localStorage je pr√°zdny, pok√∫s sa obnovi≈• z IndexedDB
          if (!storedData || Object.keys(storedData).length === 0) {
            console.log('‚ö†Ô∏è localStorage je pr√°zdny, pok√∫≈°am sa obnovi≈• z IndexedDB...');
            const recoveredData = await recoverData();
            if (recoveredData) {
              storedData = recoveredData;
              console.log('‚úÖ D√°ta √∫spe≈°ne obnoven√© z IndexedDB');
            } else {
              storedData = {};
            }
          }

          monthData = storedData;
          const storedHourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage')));
          const storedTaxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate')));
          const storedDarkMode = JSON.parse(localStorage.getItem('darkMode'));
          const storedDecimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
          const storedEmployeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
          decimalPlaces = storedDecimalPlaces;
          decimalPlacesSelect.value = decimalPlaces;
          employeeName = storedEmployeeName;
          employeeNameInput.value = employeeName;
          if (!isNaN(storedHourlyWage)) {
            hourlyWage = storedHourlyWage;
            hourlyWageInput.value = hourlyWage;
            console.log(`Nastaven√° hodinov√° mzda: ${hourlyWage}`);
          }
          if (!isNaN(storedTaxRate)) {
            taxRate = storedTaxRate;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            console.log(`Nastaven√Ω da≈àov√Ω percento: ${taxRate * 100}%`);
          }
          const data = (monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
          console.log(`Naƒç√≠tan√© d√°ta pre aktu√°lny mesiac:`, data);
          data.forEach((day, index) => {
            const i = index + 1;
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);
            if (startElement && endElement && breakElement && grossElement && netElement) {
              startElement.value = day.start || '';
              endElement.value = day.end || '';
              breakElement.value = day.breakTime || '';
              grossElement.value = day.gross || '0.00';
              netElement.value = day.net || '0.00';
              calculateRow(i);
              console.log(`De≈à ${i}:`, day);
            } else {
              console.warn(`Ch√Ωbaj√∫ci element pre de≈à ${i}`);
            }
          });
          calculateTotal();
          updateDataSize();
          if (storedDarkMode) {
            document.body.classList.add('dark-mode');
            document.querySelector('.container').classList.add('dark-mode');
            document.querySelectorAll('table, th, td, input').forEach(element => {
              element.classList.add('dark-mode');
            });
            document.querySelectorAll('.btn').forEach(button => {
              button.classList.add('dark-mode');
            });
            totalSalaryDiv.classList.add('dark-mode');
            mainTitle.classList.add('dark-mode');
            document.querySelector('.autor-info').classList.add('dark-mode');
            const currentDayRow = document.querySelector('.current-day');
            if (currentDayRow) {
              currentDayRow.classList.add('dark-mode');
            }
            console.log('Tmav√Ω re≈æim aktivovan√Ω');
          }
        } catch (error) {
          console.error('Chyba pri naƒç√≠tavan√≠ z localStorage:', error);
        }
      }

      function getDayName(year, month, day) {
        const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"];
        const date = new Date(year, month, day);
        return daysOfWeek[date.getDay()];
      }

      async function createTable() {
        workDays.innerHTML = '';
        console.log(`Vytv√°ranie tabuƒæky pre Rok=${currentYear}, Mesiac=${currentMonth}`);
        const currentDay = new Date().getDate();
        const currentMonthIndex = new Date().getMonth();
        const currentYearValue = new Date().getFullYear();
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
          const row = document.createElement('tr');
          if (i === currentDay && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
            row.classList.add('current-day');
            console.log(`Aktu√°lny de≈à ${i} zv√Ωraznen√Ω`);
          }
          const dayName = getDayName(currentYear, currentMonth, i);
          row.innerHTML = `
            <td>De≈à ${i} (${dayName})</td>
            <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td>
            <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td>
            <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prest√°vka" oninput="handleBreakInput(${i})"></td>
            <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
            <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrub√° Mzda" oninput="handleGrossInput(${i})" readonly></td>
            <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="ƒåist√° Mzda" readonly></td>
            <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulova≈•</button></td>
          `;
          workDays.appendChild(row);
        }
        await loadFromLocalStorage();
      }

      window.handleInput = function(input, nextId) {
        formatAndMoveNext(input, nextId);
        calculateAndUpdateTotals();
      }

      window.handleBreakInput = function(day) {
        calculateRow(day);
        const nextDay = day + 1;
        if (nextDay <= getDaysInMonth(currentMonth)) {
          moveNext(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`), `start-${currentYear}-${currentMonth}-${nextDay}`);
        }
        calculateAndUpdateTotals();
      }

      window.handleGrossInput = function(day) {
        updateNetSalary(day);
        calculateAndUpdateTotals();
      }

      function calculateAndUpdateTotals() {
        calculateTotal();
        debouncedSaveToLocalStorage();
      }

      function formatAndMoveNext(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, '');
        if (value.length === 4 && !value.includes(':')) {
          value = value.slice(0, 2) + ':' + value.slice(2);
        }
        input.value = value;
        const day = parseInt(input.id.split('-')[3]);
        calculateRow(day);
        if (value.length === 5) {
          const [hours, minutes] = value.split(':').map(Number);
          if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
            moveNext(input, nextId);
          } else {
            alert("Neplatn√Ω ƒças. Pros√≠m, zadajte ƒças vo form√°te HH:MM (napr. 06:30).");
            input.value = '';
          }
        }
      }

      function moveNext(currentElement, nextId) {
        const nextElement = document.getElementById(nextId);
        if (nextElement) {
          nextElement.focus();
        }
      }

      function calculateRow(day) {
        const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`).value;
        const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`).value;
        const breakTime = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`).value) || 0;
        if (startTime && endTime) {
          const [startHours, startMinutes] = startTime.split(':').map(Number);
          const [endHours, endMinutes] = endTime.split(':').map(Number);
          const startDate = new Date();
          startDate.setHours(startHours, startMinutes, 0, 0);
          const endDate = new Date();
          endDate.setHours(endHours, endMinutes, 0, 0);
          let diff = (endDate - startDate) / 60000 - (breakTime * 60);
          if (diff < 0) diff += 24 * 60;
          const hours = Math.floor(diff / 60);
          const minutes = Math.round(diff % 60);
          const decimalHours = (diff / 60).toFixed(decimalPlaces);
          const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
          totalCell.textContent = `${hours}h ${minutes}m (${decimalHours} h)`;
          const grossSalary = (diff / 60) * hourlyWage;
          document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`).value =
            isFinite(grossSalary) ? grossSalary.toFixed(decimalPlaces) : '0.00';
          updateNetSalary(day);
        }
      }

      function updateNetSalary(day) {
        const grossSalary = parseFloat(document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`).value) || 0;
        const netSalary = grossSalary * (1 - taxRate);
        document.getElementById(`net-${currentYear}-${currentMonth}-${day}`).value =
          isFinite(netSalary) ? netSalary.toFixed(decimalPlaces) : '0.00';
      }

      window.resetRow = function(day) {
        document.getElementById(`start-${currentYear}-${currentMonth}-${day}`).value = '';
        document.getElementById(`end-${currentYear}-${currentMonth}-${day}`).value = '';
        document.getElementById(`break-${currentYear}-${currentMonth}-${day}`).value = '';
        document.getElementById(`total-${currentYear}-${currentMonth}-${day}`).textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
        document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`).value = '0.00';
        document.getElementById(`net-${currentYear}-${currentMonth}-${day}`).value = '0.00';
        calculateAndUpdateTotals();
      };

      window.resetAll = async function() {
        if (confirm('Ste si ist√Ω, ≈æe chcete resetova≈• d√°ta pre aktu√°lny mesiac? T√°to akcia sa ned√° vr√°ti≈• sp√§≈•.')) {
          if (monthData[currentYear] && monthData[currentYear][currentMonth]) {
            delete monthData[currentYear][currentMonth];
            console.log(`D√°ta pre Rok=${currentYear}, Mesiac=${currentMonth} vymazan√©`);
          }
          localStorage.setItem('workDaysData', JSON.stringify(monthData));
          await createTable();
          calculateTotal();
        }
      };

      function calculateTotal() {
        let totalMinutes = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithEntries = 0;
        workDays.querySelectorAll('tr').forEach(row => {
          const totalCell = row.children[4];
          const grossInput = row.children[5].querySelector('input');
          const netInput = row.children[6].querySelector('input');
          if (totalCell && grossInput && netInput) {
            const totalText = totalCell.textContent;
            const match = totalText.match(/(\d+)h (\d+)m \(([\d.]+) h\)/);
            if (match) {
              const hours = parseInt(match[1]) || 0;
              const minutes = parseInt(match[2]) || 0;
              totalMinutes += hours * 60 + minutes;
              const grossSalary = parseFloat(grossInput.value) || 0;
              totalGrossSalary += grossSalary;
              const netSalary = parseFloat(netInput.value) || 0;
              totalNetSalary += netSalary;
              if (grossSalary > 0 || netSalary > 0) {
                daysWithEntries += 1;
              }
            }
          }
        });
        const totalHours = Math.floor(totalMinutes / 60);
        const totalMinutesRemainder = Math.round(totalMinutes % 60);
        const totalDecimalHours = (totalMinutes / 60).toFixed(decimalPlaces);
        let averageNetSalary = 0;
        if (daysWithEntries > 0) {
          averageNetSalary = (totalNetSalary / daysWithEntries).toFixed(decimalPlaces);
        }
        let averageWorkedMinutes = 0;
        if (daysWithEntries > 0) {
          averageWorkedMinutes = totalMinutes / daysWithEntries;
        }
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = (averageWorkedMinutes / 60).toFixed(decimalPlaces);
        totalSalaryDiv.innerHTML = `
          Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>
          Celkov√Ω odpracovan√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours} h)<br>
          Celkov√° hrub√° mzda: ${totalGrossSalary.toFixed(decimalPlaces)}‚Ç¨<br>
          Celkov√° ƒçist√° mzda: ${totalNetSalary.toFixed(decimalPlaces)}‚Ç¨<br>
          Priemern√° ƒçist√° mzda: ${averageNetSalary}‚Ç¨<br>
          <strong>Priemern√Ω odpracovan√Ω ƒças: ${averageHours}h ${averageMinutes}m (${averageDecimalHours} h)</strong>
        `;
      }

      window.exportToPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
        doc.setFont('Roboto');
        doc.setFontSize(18);
        doc.text(`Bruno's Calculator - V√Ωkaz pr√°ce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
        doc.setFontSize(14);
        doc.text(`Meno pracovn√≠ka: ${employeeName}`, 14, 25);
        const tableData = [];
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          const dayName = getDayName(currentYear, currentMonth, i);
          const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`).value;
          const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`).value;
          const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`).value;
          const totalTime = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`).textContent;
          const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`).value;
          const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`).value;
          if (startTime || endTime || breakTime) {
            tableData.push([`De≈à ${i} (${dayName})`, startTime, endTime, breakTime, totalTime, grossSalary, netSalary]);
          }
        }
        doc.autoTable({
          head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka', 'Odpracovan√©', 'Hrub√° Mzda (‚Ç¨)', 'ƒåist√° Mzda (‚Ç¨)']],
          body: tableData,
          startY: 30,
          styles: { font: 'Roboto' },
          headStyles: { fillColor: [41, 128, 185], textColor: 255 },
          alternateRowStyles: { fillColor: [245, 245, 245] },
          margin: { top: 25 }
        });
        const totalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(12);
        doc.text(totalSalaryDiv.innerText, 14, totalY);
        doc.save(`brunos-calculator-report-${getMonthName(currentMonth)}-${currentYear}.pdf`);
      };

      window.sendPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
        doc.setFont('Roboto');
        doc.setFontSize(18);
        doc.text(`Bruno's Calculator - V√Ωkaz pr√°ce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
        doc.setFontSize(14);
        doc.text(`Meno pracovn√≠ka: ${employeeName}`, 14, 25);
        const tableData = [];
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          const dayName = getDayName(currentYear, currentMonth, i);
          const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`).value;
          const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`).value;
          const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`).value;
          const totalTime = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`).textContent;
          const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`).value;
          const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`).value;
          if (startTime || endTime || breakTime) {
            tableData.push([`De≈à ${i} (${dayName})`, startTime, endTime, breakTime, totalTime, grossSalary, netSalary]);
          }
        }
        doc.autoTable({
          head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka', 'Odpracovan√©', 'Hrub√° Mzda (‚Ç¨)', 'ƒåist√° Mzda (‚Ç¨)']],
          body: tableData,
          startY: 30,
          styles: { font: 'Roboto' },
          headStyles: { fillColor: [41, 128, 185], textColor: 255 },
          alternateRowStyles: { fillColor: [245, 245, 245] },
          margin: { top: 25 }
        });
        const totalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(12);
        doc.text(totalSalaryDiv.innerText, 14, totalY);
        const pdfBlob = doc.output('blob');
        const pdfFile = new File(
          [pdfBlob],
          `brunos-calculator-report-${getMonthName(currentMonth)}-${currentYear}.pdf`,
          { type: 'application/pdf' }
        );
        if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
          navigator.share({
            files: [pdfFile],
            title: `Bruno's Calculator Report`,
            text: `Pozrite si v√Ωkaz pr√°ce za ${getMonthName(currentMonth)} ${currentYear}`
          })
          .then(() => console.log('PDF bolo √∫spe≈°ne odoslan√©'))
          .catch(error => {
            console.error('Chyba pri odosielan√≠ PDF:', error);
            alert('Nastala chyba pri odosielan√≠ PDF.');
          });
        } else {
          alert('Funkcia zdieƒæania s√∫borov nie je podporovan√° vo va≈°om prehliadaƒçi.');
        }
      };

      window.createBackup = function() {
        const backup = {
          workDaysData: localStorage.getItem('workDaysData'),
          hourlyWage: localStorage.getItem('hourlyWage'),
          taxRate: localStorage.getItem('taxRate'),
          darkMode: localStorage.getItem('darkMode'),
          decimalPlaces: localStorage.getItem('decimalPlaces'),
          employeeName: localStorage.getItem('employeeName')
        };
        const backupJSON = JSON.stringify(backup, null, 2);
        const blob = new Blob([backupJSON], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      window.restoreBackup = function() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.onchange = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const backup = JSON.parse(e.target.result);
              if (backup.workDaysData !== undefined) localStorage.setItem('workDaysData', backup.workDaysData);
              if (backup.hourlyWage !== undefined) localStorage.setItem('hourlyWage', backup.hourlyWage);
              if (backup.taxRate !== undefined) localStorage.setItem('taxRate', backup.taxRate);
              if (backup.darkMode !== undefined) localStorage.setItem('darkMode', backup.darkMode);
              if (backup.decimalPlaces !== undefined) localStorage.setItem('decimalPlaces', backup.decimalPlaces);
              if (backup.employeeName !== undefined) localStorage.setItem('employeeName', backup.employeeName);
              await createTable();
              calculateTotal();
              updateDataSize();
              alert("Obnovenie z√°lohy bolo √∫spe≈°n√©.");
            } catch (error) {
              console.error("Chyba pri obnove z√°lohy:", error);
              alert("Nastala chyba pri obnove z√°lohy.");
            }
          };
          reader.readAsText(file);
        };
        fileInput.click();
      };

      window.toggleDarkMode = function() {
        document.body.classList.toggle('dark-mode');
        document.querySelector('.container').classList.toggle('dark-mode');
        document.querySelectorAll('table, th, td, input').forEach(element => {
          element.classList.toggle('dark-mode');
        });
        document.querySelectorAll('.btn').forEach(button => {
          button.classList.toggle('dark-mode');
        });
        totalSalaryDiv.classList.toggle('dark-mode');
        mainTitle.classList.toggle('dark-mode');
        document.querySelector('.autor-info').classList.toggle('dark-mode');
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) {
          currentDayRow.classList.toggle('dark-mode');
        }
        localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
        updateDataSize();
      };

      function loadDarkMode() {
        const darkMode = JSON.parse(localStorage.getItem('dark-mode')) || JSON.parse(localStorage.getItem('darkMode')) || false;
        if (darkMode) {
          document.body.classList.add('dark-mode');
          document.querySelector('.container').classList.add('dark-mode');
          document.querySelectorAll('table, th, td, input').forEach(element => {
            element.classList.add('dark-mode');
          });
          document.querySelectorAll('.btn').forEach(button => {
            button.classList.add('dark-mode');
          });
          totalSalaryDiv.classList.add('dark-mode');
          mainTitle.classList.add('dark-mode');
          document.querySelector('.autor-info').classList.add('dark-mode');
          const currentDayRow = document.querySelector('.current-day');
          if (currentDayRow) {
            currentDayRow.classList.add('dark-mode');
          }
          console.log('Tmav√Ω re≈æim aktivovan√Ω');
        }
      }

      window.changeDecimalPlaces = function() {
        decimalPlaces = parseInt(decimalPlacesSelect.value);
        console.log(`Zmena poƒçtu desatinn√Ωch miest na: ${decimalPlaces}`);
        localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
        calculateTotal();
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          calculateRow(i);
        }
      };

      window.updateEmployeeName = function() {
        employeeName = employeeNameInput.value.trim();
        console.log(`Aktualizovan√© meno pracovn√≠ka: ${employeeName}`);
        localStorage.setItem('employeeName', JSON.stringify(employeeName));
        debouncedSaveToLocalStorage();
      };

      window.updateSettings = function() {
        hourlyWage = parseFloat(hourlyWageInput.value);
        taxRate = parseFloat(taxRateInput.value) / 100;
        console.log(`Aktualizovan√© nastavenia: Hodinov√° mzda=${hourlyWage}, Da≈àov√© percento=${taxRate * 100}%`);
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          calculateRow(i);
        }
        calculateAndUpdateTotals();
      };

      window.changeMonth = async function() {
        currentMonth = parseInt(monthSelect.value);
        console.log(`Zmena mesiaca: Mesiac=${currentMonth}, Rok=${currentYear}`);
        await createTable();
      };

      window.changeYear = async function() {
        currentYear = parseInt(yearSelect.value);
        console.log(`Zmena roka: Rok=${currentYear}, Mesiac=${currentMonth}`);
        await createTable();
      };

      function getDaysInMonth(month) {
        return new Date(currentYear, month + 1, 0).getDate();
      }

      function getMonthName(month) {
        const monthNames = [
          "Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n",
          "J√∫l", "August", "September", "Okt√≥ber", "November", "December"
        ];
        return monthNames[month];
      }

      function updateDataSize() {
        try {
          const workDaysData = localStorage.getItem('workDaysData') || '{}';
          const hourlyWage = localStorage.getItem('hourlyWage') || '';
          const taxRate = localStorage.getItem('taxRate') || '';
          const darkMode = localStorage.getItem('darkMode') || 'false';
          const decimalPlacesStored = localStorage.getItem('decimalPlaces') || '1';
          const employeeNameStored = localStorage.getItem('employeeName') || '""';
          const totalData = workDaysData + hourlyWage + taxRate + darkMode + decimalPlacesStored + employeeNameStored;
          const bytes = new Blob([totalData]).size;
          const kilobytes = (bytes / 1024).toFixed(2);
          const percentageUsed = Math.min(((bytes / MAX_DATA_SIZE) * 100).toFixed(2), 100);
          dataSizeText.textContent = `Veƒækos≈• d√°t: ${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
          dataSizeFill.style.width = `${percentageUsed}%`;
          if (percentageUsed > 80) {
            dataSizeFill.style.backgroundColor = '#f44336';
          } else if (percentageUsed > 50) {
            dataSizeFill.style.backgroundColor = '#ff9800';
          } else {
            dataSizeFill.style.backgroundColor = '#4CAF50';
          }
          if (bytes > MAX_DATA_SIZE) {
            dataSizeFill.style.backgroundColor = '#f44336';
            alert(`Aktu√°lna veƒækos≈• d√°t (${kilobytes} KB) prekroƒçila maxim√°lnu povolen√∫ veƒækos≈• (${MAX_DATA_SIZE_KB} KB). Pok√∫ste sa zn√≠≈æi≈• mno≈æstvo ulo≈æen√Ωch d√°t.`);
            console.warn('D√°ta prekroƒçili limit veƒækosti.');
          } else {
            console.log(`Aktu√°lna veƒækos≈• d√°t: ${kilobytes} KB (${percentageUsed}%)`);
          }
        } catch (error) {
          console.error('Chyba pri v√Ωpoƒçte veƒækosti d√°t:', error);
          dataSizeText.textContent = `Veƒækos≈• d√°t: Nepodarilo sa vypoƒç√≠ta≈•`;
        }
      }

      await createTable();
      calculateTotal();
      loadDarkMode();
      updateDataSize();
    });
  </script>
</body>
</html>
